<html>

<head>
   <meta charset="UTF-8">
   <title>Test serial communication with Microbit</title>


</head>

<body>

   <div>
      <p style="text-align: left;">
         <button id="connectBtn">Connect</button>
      </p>
   </div>

   <script>


      // global
      let writer
      let port
      let connected = false


      setInterval(async () => {
         if (connected)
            await writer.write("Hello"+"\n")
      }, 500)
      
      let connectPortBtn = document.getElementById('connectBtn')
      connectPortBtn.addEventListener('click', async () => {
         if (connected) {
            connectPortBtn.innerText = "Disconnecting..."
            try {
               await writer.releaseLock()
            } catch (err) {
               console.error(err)
            }
            try {
               await writer.close()
            } catch (err) {
               console.error(err)
            }
            try {
               await port.close()
            } catch (err) {
               console.error(err)
            }
            connected = false
         }
         else {
            try {
               connectPortBtn.innerText = "Connecting..."
               // prompt for which port to use
               port = await navigator.serial.requestPort()
               // open the port
               await port.open({ baudRate: 115200 })
               // pipe a writer to the port
               const textEncoder = new TextEncoderStream()
               const writableStreamClosed = textEncoder.readable.pipeTo(port.writable)
               writer = textEncoder.writable.getWriter()

               connected = true

            } catch (err) {
               console.error(err)
               alert('Could not find/connect to port')
            }
         }
         connected ? connectPortBtn.innerText = "Disconnect" : connectPortBtn.innerText = "Connect"
      })

   </script>
</body>

</html>